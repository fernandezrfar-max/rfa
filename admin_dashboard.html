<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Panel de Administrador</title>

Â  <style>
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: 'Inter', Arial, sans-serif; /* Usando Inter para una mejor estÃ©tica */
Â  Â  Â  background: #f6f6f6;
Â  Â  }
Â  Â  header {
Â  Â  Â  background: #009688;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 15px;
Â  Â  Â  text-align: center;
Â  Â  Â  font-size: 22px;
Â  Â  Â  position: sticky;
Â  Â  Â  top: 0;
Â  Â  Â  border-bottom-left-radius: 10px;
Â  Â  Â  border-bottom-right-radius: 10px;
Â  Â  }
Â  Â  .container {
Â  Â  Â  padding: 20px;
Â  Â  Â  text-align: center;
Â  Â  Â  padding-bottom: 120px;
Â  Â  }
Â  Â  .logo img {
Â  Â  Â  width: 150px;
Â  Â  Â  margin: 20px auto;
Â  Â  }
Â  Â  h2 {
Â  Â  Â  color: #00695c;
Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  font-size: 24px;
Â  Â  }

Â  Â  .btn-plan {
Â  Â  Â  background: #1976d2;
Â  Â  Â  color: white;
Â  Â  Â  padding: 18px 25px;
Â  Â  Â  border-radius: 25px;
Â  Â  Â  display: block;
Â  Â  Â  width: 100%;
Â  Â  Â  max-width: 360px;
Â  Â  Â  margin: 10px auto 30px auto;
Â  Â  Â  font-size: 17px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  text-decoration: none;
Â  Â  Â  transition: transform 0.2s, box-shadow 0.2s;
Â  Â  Â  box-shadow: 0 6px 15px rgba(25, 118, 210, 0.4);
Â  Â  }
Â  Â  .btn-plan:hover {
Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  box-shadow: 0 8px 20px rgba(25, 118, 210, 0.6);
Â  Â  }

Â  Â  .stats-title {
Â  Â  Â  text-align: left;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 20px;
Â  Â  Â  margin-top: 10px;
Â  Â  }
Â  Â  .stats-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  gap: 15px;
Â  Â  Â  margin-top: 15px;
Â  Â  }

    /* Estilo base para las tarjetas/botones de estadÃ­sticas */
Â  Â  .card-link {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: center;
Â  Â  Â  padding: 25px;
Â  Â  Â  border-radius: 15px;
Â  Â  Â  color: white;
Â  Â  Â  text-align: center;
Â  Â  Â  font-size: 18px;
Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
Â  Â  Â  text-decoration: none; /* Quitamos el subrayado del enlace */
Â  Â  Â  transition: transform 0.2s, box-shadow 0.2s;
Â  Â  }
Â  Â  .card-link:hover {
Â  Â  Â  transform: translateY(-3px);
Â  Â  Â  box-shadow: 0 8px 15px rgba(0,0,0,0.2);
Â  Â  }

    /* Estilos de color */
Â  Â  .c1 { background: linear-gradient(135deg, #2196f3, #1565c0); }
Â  Â  .c2 { background: linear-gradient(135deg, #ab47bc, #7b1fa2); }
Â  Â  .c3 { background: linear-gradient(135deg, #43a047, #2e7d32); }
Â  Â  .c4 { background: linear-gradient(135deg, #ff9800, #ef6c00); }
    
    .card-number {
        font-size: 36px;
        font-weight: bold;
        margin-top: 5px;
    }


Â  Â  .subtitle-left {
Â  Â  Â  text-align: left;
Â  Â  Â  font-size: 20px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-top: 25px;
Â  Â  }

Â  Â  .calendar-btn {
Â  Â  Â  margin-top: 40px;
Â  Â  Â  padding: 18px 25px;
Â  Â  Â  border-radius: 25px;
Â  Â  Â  border: 2px solid #00695c;
Â  Â  Â  color: #00695c;
Â  Â  Â  display: block;
Â  Â  Â  width: 100%;
Â  Â  Â  max-width: 320px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: bold;
Â  Â  Â  text-decoration: none;
Â  Â  Â  background: #ffffff;
Â  Â  Â  margin-left: auto;
Â  Â  Â  margin-right: auto;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
    .calendar-btn:hover {
        background: #e0f2f1;
    }

Â  Â  .bottom-nav {
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  background: #fff;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-around;
Â  Â  Â  padding: 10px 0;
Â  Â  Â  box-shadow: 0 -3px 10px rgba(0,0,0,0.1);
Â  Â  Â  z-index: 20;
Â  Â  }

Â  Â  .nav-item {
Â  Â  Â  text-align: center;
Â  Â  Â  color: #00695c;
Â  Â  Â  font-size: 14px;
Â  Â  Â  text-decoration: none;
Â  Â  }

Â  Â  .nav-item img {
Â  Â  Â  width: 22px;
Â  Â  Â  opacity: 0.8;
Â  Â  }
Â  </style>
</head>
<body>

Â  <header style="display:flex; justify-content:space-between; align-items:center;">
Â  <span>Panel de Administrador</span>

Â  <a href="app.html"Â 
Â  Â  Â style="
Â  Â  Â  Â  background:#e53935;
Â  Â  Â  Â  color:white;
Â  Â  Â  Â  padding:8px 15px;
Â  Â  Â  Â  border-radius:8px;
Â  Â  Â  Â  text-decoration:none;
Â  Â  Â  Â  font-size:14px;
Â  Â  Â ">
Â  Â  Salir
Â  </a>
</header>

Â  <div class="container">
Â  Â  <div class="logo">
Â  Â  Â  <img src="https://placehold.co/150x150/009688/ffffff?text=Logo" alt="logo" onerror="this.src='logo.png';" />
Â  Â  </div>

Â  Â  <h2>MD. DR. RICARDO FERNÃNDEZ AMAYA</h2>

Â  Â  <p style="text-align:left;font-size:18px;font-weight:bold;margin-top:20px;">
Â  Â  Â  Accede a Planes de Entrenamiento
Â  Â  </p>

Â  Â  <a href="ejercicios.html" class="btn-plan">ğŸ”§ Plan de Entrenamiento</a>

Â  Â  <p class="stats-title">ğŸ“Š EstadÃ­sticas Clave</p>

Â  Â  <div class="stats-grid">
Â  Â  Â  <!-- Tarjeta 1: Pacientes (Redirige a pacientes.html) -->
Â  Â  Â  <a href="pacientes.html" class="card-link c1">
Â  Â  Â  Â  <div class="card-text">Pacientes</div>
Â  Â  Â  Â  <div class="card-number" id="pacientes">-</div>
Â  Â  Â  </a>

Â  Â  Â  <!-- Tarjeta 2: Planes Activos (Redirige a ejercicios.html#planes-asignados) -->
Â  Â  Â  <a href="ejercicios.html#planes-asignados" class="card-link c2">
Â  Â  Â  Â  <div class="card-text">Planes Activos</div>
Â  Â  Â  Â  <div class="card-number" id="planes">-</div>
Â  Â  Â  </a>

Â  Â  Â  <!-- Tarjeta 3: Entrenamiento (Mantiene el estilo de tarjeta/botÃ³n) -->
Â  Â  Â  <a href="#" class="card-link c3">
Â  Â  Â  Â  <div class="card-text">Entrenamiento</div>
Â  Â  Â  Â  <div class="card-number" id="entrenamiento">-</div>
Â  Â  Â  </a>

Â  Â  Â  <!-- Tarjeta 4: Promedios (Mantiene el estilo de tarjeta/botÃ³n) -->
Â  Â  Â  <a href="#" class="card-link c4">
Â  Â  Â  Â  <div class="card-text">Promedios</div>
Â  Â  Â  Â  <div class="card-number" id="promedios">-</div>
Â  Â  Â  </a>
Â  Â  </div>

Â  Â  <p class="subtitle-left">GestiÃ³n de Pacientes</p>

Â  Â  <!-- AquÃ­ podrÃ­a ser el ancla para la redirecciÃ³n, aunque el hash en el href es suficiente si la secciÃ³n existe en el otro HTML -->
Â  Â  <a id="planes-asignados"></a>

Â  Â  <!-- ğŸ”¥ AQUÃ APARECEN LOS 3 PACIENTES -->
Â  Â  <div id="resumenPacientes" style="text-align:left; margin-top:10px;">
Â  Â  Â  Â  <p style="color:gray;">Cargando pacientes...</p>
Â  Â  </div>

Â  Â  <a href="pacientes.html" style="
Â  Â  Â  Â  display:inline-block;
Â  Â  Â  Â  margin-top:10px;
Â  Â  Â  Â  font-size:16px;
Â  Â  Â  Â  color:#1976d2;
Â  Â  Â  Â  text-decoration:none;
Â  Â  Â  Â  font-weight: 500;
Â  Â  ">
Â  Â  Â  Â  Ver todos los pacientes â†’
Â  Â  </a>

Â  Â  <p style="text-align:left;color:gray;">________________________________________________</p>

Â  Â  <a href="calendario.html" class="calendar-btn">ğŸ“… Calendario de Citas</a>
Â  </div>

Â  <div class="bottom-nav">
Â  Â  <a href="admin_dashboard.html" class="nav-item">
Â  Â  Â  <img src="https://placehold.co/22x22/00695C/ffffff?text=D" onerror="this.src='logo.png'" />
Â  Â  Â  <br>Dashboard
Â  Â  </a>

Â  Â  <a href="pacientes.html" class="nav-item">
Â  Â  Â  <img src="https://placehold.co/22x22/00695C/ffffff?text=P" onerror="this.src='logo.png'" />
Â  Â  Â  <br>Pacientes
Â  Â  </a>

Â  Â  <a href="ejercicios.html" class="nav-item">
Â  Â  Â  <img src="https://placehold.co/22x22/00695C/ffffff?text=E" style="transform:rotate(45deg);" onerror="this.src='logo.png'" />
Â  Â  Â  <br>Ejercicios
Â  Â  </a>
Â  </div>


<!-- FIREBASE SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, limit }Â 
Â  Â  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";


// Global variables for Canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Fallback configuration if running outside Canvas
if (Object.keys(firebaseConfig).length === 0) {
    Object.assign(firebaseConfig, {
        apiKey: "AIzaSyD-w5QswIehqDGUohWReinNK5MXFW0C_Nw",
        authDomain: "rfa-2025.firebaseapp.com",
        projectId: "rfa-2025",
        storageBucket: "rfa-2025.firebasestorage.app",
        messagingSenderId: "113686586280",
        appId: "1:113686586280:web:223b4277f53ca0607c339d",
        measurementId: "G-T7F5V4WGY9"
    });
}


const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let userId = null; // Will be set after auth

// 1. Authentication Setup
async function authenticateUser() {
    try {
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }
        userId = auth.currentUser?.uid || 'anonymous';
        console.log("Firebase authentication successful. User ID:", userId);
        // Start loading data only after successful auth
        cargarResumenPacientes();
        cargarEstadisticas();

    } catch (error) {
        console.error("Firebase authentication failed:", error);
    }
}

// ========================================================
// ğŸ”¥ CORREGIDO: MOSTRAR 3 PACIENTES REALES DE FIRESTORE
// ========================================================
async function cargarResumenPacientes() {
    if (!userId) {
        console.log("Waiting for user authentication before loading patients...");
        return;
    }
Â  Â  const cont = document.getElementById("resumenPacientes");
    const pacientesCollectionPath = `/artifacts/${appId}/public/data/pacientes`;

Â  Â  try {
Â  Â  Â  Â  const q = query(
Â  Â  Â  Â  Â  Â  collection(db, pacientesCollectionPath),
Â  Â  Â  Â  Â  Â  limit(3)
Â  Â  Â  Â  );

Â  Â  Â  Â  const snap = await getDocs(q);

Â  Â  Â  Â  if (snap.empty) {
Â  Â  Â  Â  Â  Â  cont.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <p style="color:gray;">No hay pacientes registrados todavÃ­a.</p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let html = "";

Â  Â  Â  Â  snap.forEach(doc => {
Â  Â  Â  Â  Â  Â  const p = doc.data();

Â  Â  Â  Â  Â  Â  const nombrePaciente =
Â  Â  Â  Â  Â  Â  Â  Â  p.nombre ||
Â  Â  Â  Â  Â  Â  Â  Â  p.usuario ||
Â  Â  Â  Â  Â  Â  Â  Â  "Paciente sin nombre";

Â  Â  Â  Â  Â  Â  const foto =
Â  Â  Â  Â  Â  Â  Â  Â  p.foto && p.foto.trim() !== ""
Â  Â  Â  Â  Â  Â  Â  Â  ? p.foto
Â  Â  Â  Â  Â  Â  Â  Â  : "https://placehold.co/55x55/9e9e9e/ffffff?text=ğŸ‘¤"; // Placeholder de usuario

Â  Â  Â  Â  Â  Â  const plan =
Â  Â  Â  Â  Â  Â  Â  Â  p.planAsignado ||
Â  Â  Â  Â  Â  Â  Â  Â  (p.planesAsignados && p.planesAsignados[0]?.nombre) ||
Â  Â  Â  Â  Â  Â  Â  Â  "Sin plan";

Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  align-items:center;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background:white;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  padding:12px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border-radius:12px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom:12px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  box-shadow:0 2px 8px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  Â  Â  ">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${foto}" style="
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width:55px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height:55px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border-radius:50%;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  object-fit:cover;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  margin-right:12px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  " onerror="this.onerror=null;this.src='https://placehold.co/55x55/9e9e9e/ffffff?text=ğŸ‘¤';">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:17px;font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${nombrePaciente}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color:gray;font-size:14px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${plan}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- CORREGIDO: REDIRIGE a pacientes.html para ver detalles -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="pacientes.html?id=${doc.id}" style="
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  padding:8px 12px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background:#1976d2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color:white;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border-radius:8px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font-size:14px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text-decoration:none;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transition: opacity 0.2s;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ver
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });

Â  Â  Â  Â  cont.innerHTML = html;

Â  Â  } catch (e) {
Â  Â  Â  Â  cont.innerHTML = `<p style="color:red;">Error al cargar pacientes: ${e.message}</p>`;
Â  Â  Â  Â  console.error("Error al cargar pacientes:", e);
Â  Â  }
}


// =======================================
// ğŸ“Š ESTADÃSTICAS DEL DASHBOARD
// =======================================

// Contar documentos en una colecciÃ³n
async function contarDocumentos(collectionName) {
    if (!userId) {
        console.log("Waiting for user authentication before counting documents...");
        return 0;
    }
    const collectionPath = `/artifacts/${appId}/public/data/${collectionName}`;

Â  Â  try {
        // Usamos una consulta simple para contar documentos en la colecciÃ³n pÃºblica
        const q = query(collection(db, collectionPath));
Â  Â  Â  Â  const snap = await getDocs(q);
Â  Â  Â  Â  return snap.size;
Â  Â  } catch (e) {
        console.error(`Error contando documentos en ${collectionName}:`, e);
        return 0;
    }
}

async function cargarEstadisticas() {
    if (!userId) {
        console.log("Waiting for user authentication before loading stats...");
        return;
    }

Â  Â  try {

Â  Â  Â  Â  // ğŸ”¥ 1. TOTAL DE PACIENTES
Â  Â  Â  Â  const totalPacientes = await contarDocumentos("pacientes");
Â  Â  Â  Â  document.getElementById("pacientes").textContent = totalPacientes;

Â  Â  Â  Â  // ğŸ”¥ 2. TOTAL DE PLANES
Â  Â  Â  Â  const totalPlanes = await contarDocumentos("planes");
Â  Â  Â  Â  document.getElementById("planes").textContent = totalPlanes;

Â  Â  Â  Â  // ğŸ”¥ 3. ENTRENAMIENTOS (si tu colecciÃ³n se llama diferente, dime)
Â  Â  Â  Â  const totalEjercicios = await contarDocumentos("ejercicios");
Â  Â  Â  Â  document.getElementById("entrenamiento").textContent = totalEjercicios;

Â  Â  Â  Â  // ğŸ”¥ 4. PROMEDIOS (Planes por Paciente como ejemplo)
Â  Â  Â  Â  let promedio = 0;
Â  Â  Â  Â  if (totalPacientes > 0) {
Â  Â  Â  Â  Â  Â  promedio = (totalPlanes / totalPacientes).toFixed(1);
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById("promedios").textContent = promedio;

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error cargando estadÃ­sticas", e);
Â  Â  }
}

authenticateUser();

</script>
</body>
</html>
