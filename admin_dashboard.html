<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administrador</title>
    <!-- Carga de la fuente Inter para mejor est√©tica -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ==================================== */
        /* CSS: ESTILOS GENERALES Y LAYOUT */
        /* ==================================== */

        body {
            margin: 0;
            font-family: 'Inter', Arial, sans-serif;
            background: #f6f6f6;
            color: #333; 
        }
        .container {
            padding: 20px;
            text-align: center;
            padding-bottom: 120px; /* Espacio para el nav fijo */
        }
        
        /* HEADER (Barra superior) */
        header {
            background: #009688; /* Verde Teal */
            color: #fff;
            padding: 15px 20px;
            font-size: 22px;
            position: sticky;
            top: 0;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
            display:flex; 
            justify-content:space-between; 
            align-items:center;
        }

        /* Bot√≥n de Salir en el Header */
        .btn-salir {
            background:#e53935; /* Rojo */
            color:white;
            padding:8px 15px;
            border-radius:8px;
            text-decoration:none;
            font-size:14px;
            transition: background 0.2s;
        }
        .btn-salir:hover {
            background: #c62828;
        }
        
        /* Logo/Foto de Perfil */
        .logo img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin: 20px auto;
            border: 4px solid #009688;
        }
        h2 {
            color: #00695c;
            margin-bottom: 5px;
            font-size: 24px;
        }

        /* Bot√≥n principal (Plan de Entrenamiento) */
        .btn-plan {
            background: #1976d2; /* Azul */
            color: white;
            padding: 18px 25px;
            border-radius: 25px;
            display: block;
            width: 100%;
            max-width: 360px;
            margin: 10px auto 30px auto;
            font-size: 17px;
            font-weight: bold;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            box-shadow: 0 6px 15px rgba(25, 118, 210, 0.4);
        }
        .btn-plan:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(25, 118, 210, 0.6);
            background: #1565c0;
        }

        /* T√≠tulos de secci√≥n */
        .stats-title, .subtitle-left {
            text-align: left;
            font-weight: bold;
            font-size: 20px;
            color: #00695c;
            margin-top: 30px;
        }
        .subtitle-left {
            margin-top: 25px;
        }

        /* ==================================== */
        /* GRID DE ESTAD√çSTICAS (TARJETAS) */
        /* ==================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        /* Estilo base para las tarjetas/botones (Enlaces) */
        .card-link {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 10px;
            border-radius: 15px;
            color: white;
            text-align: center;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            text-decoration: none; 
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            min-height: 100px;
        }
        .card-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.25);
        }
        
        /* Colores de las tarjetas con gradientes */
        .c1 { background: linear-gradient(135deg, #2196f3, #1565c0); } /* Azul */
        .c2 { background: linear-gradient(135deg, #ab47bc, #7b1fa2); } /* P√∫rpura */
        .c3 { background: linear-gradient(135deg, #43a047, #2e7d32); } /* Verde */
        .c4 { background: linear-gradient(135deg, #ff9800, #ef6c00); } /* Naranja */
        
        .card-text {
            font-size: 16px;
            opacity: 0.9;
        }
        .card-number {
            font-size: 38px;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Bot√≥n del Calendario */
        .calendar-btn {
            margin-top: 40px;
            padding: 18px 25px;
            border-radius: 25px;
            border: 2px solid #00695c;
            color: #00695c;
            display: block;
            width: 100%;
            max-width: 320px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            background: #ffffff;
            margin-left: auto;
            margin-right: auto;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .calendar-btn:hover {
            background: #e0f2f1;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* ==================================== */
        /* RESUMEN DE PACIENTES */
        /* ==================================== */
        .patient-summary-card {
            display:flex;
            align-items:center;
            background:white;
            padding:12px;
            border-radius:12px;
            margin-bottom:12px;
            box-shadow:0 2px 8px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }
        .patient-summary-card:hover {
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
        }
        .patient-avatar {
            width:55px;
            height:55px;
            border-radius:50%;
            object-fit:cover;
            margin-right:12px;
            border: 2px solid #eee;
        }
        .patient-info {
            flex:1;
            text-align: left;
        }
        .patient-name {
            font-size:17px;
            font-weight:bold;
            color: #333;
        }
        .patient-plan {
            color:gray;
            font-size:14px;
        }
        .btn-view-patient {
            padding:8px 12px;
            background:#1976d2;
            color:white;
            border-radius:8px;
            font-size:14px;
            text-decoration:none;
            transition: background 0.2s;
        }
        .btn-view-patient:hover {
            background: #1565c0;
        }

        /* ==================================== */
        /* NAV INFERIOR (Footer Nav) */
        /* ==================================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #fff;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -3px 10px rgba(0,0,0,0.15);
            z-index: 20;
        }

        .nav-item {
            text-align: center;
            color: #00695c;
            font-size: 13px;
            text-decoration: none;
            padding: 5px 0;
            flex-grow: 1; 
            transition: color 0.2s;
        }
        .nav-item:hover {
            color: #1976d2; 
        }

        .nav-item img {
            width: 24px;
            height: 24px;
            display: block;
            margin: 0 auto 4px auto;
            opacity: 0.8;
        }
    </style>
</head>
<body>

    <header>
        <span>Panel de Administrador</span>
        <a href="app.html" class="btn-salir">
            Salir
        </a>
    </header>

    <div class="container">
        <div class="logo">
            <!-- Placeholder para la foto del doctor o logo -->
            <img 
                src="https://placehold.co/150x150/009688/ffffff?text=DR" 
                alt="logo" 
                onerror="this.src='https://placehold.co/150x150/009688/ffffff?text=DR';" 
            />
        </div>

        <h2>MD. DR. RICARDO FERN√ÅNDEZ AMAYA</h2>

        <p style="text-align:left;font-size:18px;font-weight:bold;margin-top:20px;">
            Accede a Planes de Entrenamiento
        </p>

        <a href="ejercicios.html" class="btn-plan">üîß Plan de Entrenamiento</a>

        <p class="stats-title">üìä Estad√≠sticas Clave</p>

        <div class="stats-grid">
            <!-- Tarjeta 1: Pacientes (Redirige a pacientes.html) -->
            <a href="pacientes.html" class="card-link c1">
                <div class="card-text">Pacientes</div>
                <div class="card-number" id="pacientes">-</div>
            </a>

            <!-- Tarjeta 2: Planes Activos (Redirige a ejercicios.html#planes-asignados) -->
            <a href="ejercicios.html#planes-asignados" class="card-link c2">
                <div class="card-text">Planes Activos</div>
                <div class="card-number" id="planes">-</div>
            </a>

            <!-- Tarjeta 3: Entrenamiento (Ejercicios disponibles) -->
            <a href="#" class="card-link c3">
                <div class="card-text">Ejercicios Creados</div>
                <div class="card-number" id="entrenamiento">-</div>
            </a>

            <!-- Tarjeta 4: Promedios (Planes promedio por paciente) -->
            <a href="#" class="card-link c4">
                <div class="card-text">Planes Prom.</div>
                <div class="card-number" id="promedios">-</div>
            </a>
        </div>

        <p class="subtitle-left">Gesti√≥n de Pacientes</p>

        <!-- üî• AQU√ç APARECEN LOS 3 PACIENTES -->
        <div id="resumenPacientes" style="text-align:left; margin-top:10px;">
            <p style="color:gray;">Cargando pacientes...</p>
        </div>

        <a href="pacientes.html" style="
            display:inline-block;
            margin-top:10px;
            font-size:16px;
            color:#1976d2;
            text-decoration:none;
            font-weight: 500;
            transition: opacity 0.2s;
        "
        onmouseover="this.style.opacity='0.8'"
        onmouseout="this.style.opacity='1'"
        >
            Ver todos los pacientes ‚Üí
        </a>

        <p style="text-align:left;color:#ccc;margin-top:20px;margin-bottom:20px;">
            ________________________________________________
        </p>

        <a href="calendario.html" class="calendar-btn">üìÖ Calendario de Citas</a>
    </div>

    <!-- Navegaci√≥n Inferior Fija -->
    <div class="bottom-nav">
        <a href="admin_dashboard.html" class="nav-item" style="color:#1976d2; font-weight:bold;">
            <img src="https://placehold.co/24x24/1976d2/ffffff?text=D" />
            <br>Dashboard
        </a>

        <a href="pacientes.html" class="nav-item">
            <img src="https://placehold.co/24x24/00695C/ffffff?text=P" />
            <br>Pacientes
        </a>

        <a href="ejercicios.html" class="nav-item">
            <img src="https://placehold.co/24x24/00695C/ffffff?text=E" style="transform:rotate(45deg);" />
            <br>Ejercicios
        </a>
    </div>


<!-- FIREBASE SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, limit }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";


// Global variables for Canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Fallback configuration if running outside Canvas (for testing purposes)
if (Object.keys(firebaseConfig).length === 0) {
    // This fallback is only used if the environment variables are not provided.
    // In a real Canvas environment, this block is skipped.
    Object.assign(firebaseConfig, {
        apiKey: "AIzaSyD-w5QswIehqDGUohWReinNK5MXFW0C_Nw",
        authDomain: "rfa-2025.firebaseapp.com",
        projectId: "rfa-2025",
        storageBucket: "rfa-2025.firebasestorage.app",
        messagingSenderId: "113686586280",
        appId: "1:113686586280:web:223b4277f53ca0607c339d",
        measurementId: "G-T7F5V4WGY9"
    });
}


const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let userId = null; // Will be set after auth

// 1. Authentication Setup
async function authenticateUser() {
    try {
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }
        userId = auth.currentUser?.uid || 'anonymous';
        console.log("Firebase authentication successful. User ID:", userId);
        // Start loading data only after successful auth
        cargarResumenPacientes();
        cargarEstadisticas();

    } catch (error) {
        console.error("Firebase authentication failed:", error);
    }
}

// ========================================================
// üî• CARGAR LOS 3 PACIENTES M√ÅS RECIENTES DE FIRESTORE
// ========================================================
async function cargarResumenPacientes() {
    if (!userId) {
        console.log("Waiting for user authentication before loading patients...");
        return;
    }
    const cont = document.getElementById("resumenPacientes");
    // Path for the public 'pacientes' collection
    const pacientesCollectionPath = `/artifacts/${appId}/public/data/pacientes`;

    try {
        const q = query(
            collection(db, pacientesCollectionPath),
            limit(3) // Limit to 3 documents
        );

        const snap = await getDocs(q);

        if (snap.empty) {
            cont.innerHTML = `
                <p style="color:gray;">No hay pacientes registrados todav√≠a.</p>
            `;
            return;
        }

        let html = "";

        snap.forEach(doc => {
            const p = doc.data();

            const nombrePaciente =
                p.nombre ||
                p.usuario ||
                "Paciente sin nombre";

            const foto =
                p.foto && p.foto.trim() !== ""
                ? p.foto
                : "https://placehold.co/55x55/9e9e9e/ffffff?text=üë§"; // User placeholder

            const plan =
                p.planAsignado ||
                (p.planesAsignados && p.planesAsignados.length > 0 ? p.planesAsignados[0].nombre : "Sin plan");

            html += `
                <div class="patient-summary-card">
                    <img 
                        src="${foto}" 
                        class="patient-avatar" 
                        alt="Foto de ${nombrePaciente}"
                        onerror="this.onerror=null;this.src='https://placehold.co/55x55/9e9e9e/ffffff?text=üë§';"
                    >
                    <div class="patient-info">
                        <div class="patient-name">
                            ${nombrePaciente}
                        </div>
                        <div class="patient-plan">
                            ${plan}
                        </div>
                    </div>

                    <a href="pacientes.html?id=${doc.id}" class="btn-view-patient">
                        Ver
                    </a>
                </div>
            `;
        });

        cont.innerHTML = html;

    } catch (e) {
        cont.innerHTML = `<p style="color:red;">Error al cargar pacientes: ${e.message}</p>`;
        console.error("Error al cargar pacientes:", e);
    }
}


// =======================================
// üìä ESTAD√çSTICAS DEL DASHBOARD
// =======================================

// Count documents in a collection
async function contarDocumentos(collectionName) {
    if (!userId) {
        return 0;
    }
    // Path for the public data collection
    const collectionPath = `/artifacts/${appId}/public/data/${collectionName}`;

    try {
        // We get all documents for the count
        const q = query(collection(db, collectionPath));
        const snap = await getDocs(q);
        return snap.size;
    } catch (e) {
        console.error(`Error contando documentos en ${collectionName}:`, e);
        return 0;
    }
}

async function cargarEstadisticas() {
    if (!userId) {
        console.log("Waiting for user authentication before loading stats...");
        return;
    }

    try {

        // 1. TOTAL PATIENTS
        const totalPacientes = await contarDocumentos("pacientes");
        document.getElementById("pacientes").textContent = totalPacientes;

        // 2. TOTAL PLANS (Active Plans)
        const totalPlanes = await contarDocumentos("planes");
        document.getElementById("planes").textContent = totalPlanes;

        // 3. TRAININGS (Available Exercises in the database)
        const totalEjercicios = await contarDocumentos("ejercicios");
        document.getElementById("entrenamiento").textContent = totalEjercicios;

        // 4. AVERAGES (Average Plans per Patient as example)
        let promedio = 0;
        const totalPacientesElement = document.getElementById("pacientes");
        const totalPlanesElement = document.getElementById("planes");

        // Wait for elements to be populated before calculating
        if (totalPacientes > 0) {
            // Calculates the average and limits it to one decimal
            promedio = (totalPlanes / totalPacientes).toFixed(1);
        }
        document.getElementById("promedios").textContent = promedio;

    } catch (e) {
        console.error("Error cargando estad√≠sticas", e);
    }
}

// Start authentication when the script loads
authenticateUser();

</script>
</body>
</html>
