<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Personalizaci√≥n de ejercicios</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="https://cdn.tailwindcss.com"></script>

<style>
  body {
    font-family: "Poppins", sans-serif;
    background: #f3f8fa;
    -webkit-font-smoothing: antialiased;
    color: #0f172a;
  }

  /* Encabezado moderno */
  .header {
    background: #00c3ff;
    color: white;
    padding: 18px 16px;
    border-bottom-left-radius: 18px;
    border-bottom-right-radius: 18px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
  }
  .header-title {
    font-size: 22px;
    font-weight: 600;
  }

  .card {
    background:white;
    border-radius:14px;
    box-shadow:0 4px 14px rgba(0,0,0,0.07);
    padding:14px;
  }

  .chip {
    padding:8px 12px;
    border-radius:999px;
    font-weight:600;
    transition: background-color 0.15s;
  }

  .day-chip {
    display: flex;
    align-items: center;
    gap: 4px;
    padding-right: 8px; /* Ajuste para que el icono quepa */
  }

  .day-delete {
    background: transparent;
    color: #ef4444;
    font-size: 16px;
    margin-left: 4px;
    padding: 0;
    line-height: 1;
  }
  .day-delete:hover {
    color: #b91c1c;
  }

  .modal-bg {
    background:rgba(0,0,0,0.45);
    backdrop-filter:blur(4px);
    -webkit-backdrop-filter:blur(4px);
  }
</style>
</head>

<body>

<header class="header">
  <div class="flex items-center justify-between">
    <div>
      <div class="header-title">Personalizaci√≥n de ejercicios</div>
      <div class="text-white opacity-95 text-sm mt-1">A√±ade, edita y organiza tu plan</div>
    </div>
    <button id="btn-save-all" class="chip bg-white text-sky-600">Guardar</button>
  </div>
</header>

<main class="container mx-auto px-4 py-4 space-y-4">

  <div class="card flex items-center justify-between">
    <div>
      <div class="font-semibold">A√±adir ejercicio</div>
      <div class="text-gray-500 text-sm">Abrir cat√°logo y configurar</div>
    </div>
    <button id="btn-open-catalog" class="chip bg-sky-500 text-white">+ A√±adir ejercicio</button>
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">D√≠as</div>
      <div class="flex items-center gap-2">
        <button id="btn-add-day" class="chip bg-white border">+ D√≠a</button>
        <button id="btn-import" class="chip bg-white border">Importar</button>
        <div id="days-count" class="text-gray-500 text-sm"></div>
      </div>
    </div>
    <div id="days-row" class="flex gap-2 overflow-x-auto pb-1"></div>
  </div>

  <div class="card">
    <div class="mb-2">
      <div id="active-day-title" class="font-semibold">Ejercicios</div>
      <div id="active-day-sub" class="text-gray-500 text-sm">Toca un ejercicio para editarlo</div>
    </div>
    <div id="ex-list" class="space-y-3"></div>
  </div>

</main>

<div id="overlay" class="modal-bg fixed inset-0 z-40 hidden items-center justify-center"></div>

<div id="catalog-modal" class="fixed inset-0 z-50 hidden items-start justify-center p-4 overflow-auto">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl mt-12">
    <div class="flex items-center justify-between px-4 py-3 border-b">
      <div>
        <div class="font-bold text-lg">Cat√°logo</div>
        <div class="text-gray-500 text-sm">Pulsa un grupo para ver ejercicios</div>
      </div>
      <button id="catalog-close" class="text-gray-600 text-xl">‚úï</button>
    </div>

    <div class="p-3">
      <input id="catalog-filter" placeholder="Buscar..." class="w-full p-2 border rounded mb-3" />
      <div id="catalog-root" style="max-height:60vh; overflow:auto;"></div>
    </div>

    <div class="p-3 border-t text-right flex justify-between items-center">
      <button id="catalog-cancel" class="chip bg-white border">Cerrar</button>
      <button id="catalog-add-multiple" class="chip bg-sky-500 text-white" disabled>A√±adir seleccionados (0)</button>
    </div>
  </div>
</div>

<div id="configure-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
    <div class="flex items-center justify-between px-4 py-3 border-b">
      <div>
        <div id="cfg-name" class="font-bold text-lg"></div>
        <div id="cfg-group" class="text-gray-500 text-sm"></div>
      </div>
      <button id="cfg-close" class="text-gray-600 text-xl">‚úï</button>
    </div>

    <div class="p-4 space-y-3">
      <div class="flex items-center gap-3">
        <img id="cfg-gif" class="w-24 h-20 object-contain rounded" src="" />
        <div class="flex-1">
          <label class="text-sm">Series</label>
          <input id="cfg-series" type="number" class="p-2 border rounded w-full" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Repeticiones</label>
          <input id="cfg-reps" type="number" class="p-2 border rounded w-full" />
        </div>

        <div>
          <label class="text-sm">Tiempo</label>
          <div class="flex gap-2">
            <input id="cfg-time" type="number" class="p-2 border rounded w-full" />
            <select id="cfg-time-unit" class="p-2 border rounded">
              <option value="min">min</option>
              <option value="seg">seg</option>
              <option value="N/A">N/A</option>
            </select>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3">
        <div class="col-span-2">
          <label class="text-sm">Peso</label>
          <input id="cfg-weight" type="number" class="p-2 border rounded w-full" />
        </div>

        <div>
          <label class="text-sm">Unidad</label>
          <select id="cfg-weight-unit" class="p-2 border rounded w-full">
            <option value="kg">kg</option>
            <option value="lbs">lbs</option>
            <option value="RPE">RPE</option>
          </select>
        </div>
      </div>

      <div>
        <label class="text-sm">Notas</label>
        <textarea id="cfg-notes" class="w-full p-2 border rounded" rows="3"></textarea>
      </div>
    </div>

    <div class="p-4 border-t text-right flex gap-2">
      <button id="cfg-cancel" class="chip bg-white border">Cancelar</button>
      <button id="cfg-add" class="chip bg-sky-500 text-white">Agregar</button>
    </div>
  </div>
</div>

<div id="duplicate-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow p-4 w-full max-w-sm">
    <div class="font-bold text-yellow-600 text-lg">Ejercicio duplicado</div>
    <div class="text-gray-600 mt-2">
      Ya existe este ejercicio en el d√≠a. ¬øDeseas agregarlo igualmente?
    </div>

    <div class="mt-4 flex justify-end gap-2">
      <button id="dup-no" class="chip bg-white border">No</button>
      <button id="dup-yes" class="chip bg-sky-500 text-white">S√≠, a√±adir</button>
    </div>
  </div>
</div>

<div id="gif-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow p-4 max-w-md w-full">
    <div class="flex items-center justify-between mb-3">
      <div id="gif-title" class="font-bold"></div>
      <button id="gif-close" class="text-gray-600 text-xl">‚úï</button>
    </div>
    <img id="gif-large" class="w-full rounded" src="" />
  </div>
</div>

<div id="import-modal" class="fixed inset-0 z-50 hidden items-start justify-center p-4 overflow-auto">
  <div class="bg-white rounded-xl shadow p-4 w-full max-w-lg mt-16">
    <div class="flex items-center justify-between mb-3">
      <div class="font-bold text-blue-600 text-lg">Importar plan</div>
      <button id="import-close" class="text-gray-600 text-xl">‚úï</button>
    </div>

    <div class="text-gray-600 text-sm mb-2">
      Importa desde localStorage o pega un JSON de un plan existente.
    </div>

    <input id="import-paste" class="w-full p-2 border rounded" placeholder="Pegar JSON aqu√≠" />

    <div class="mt-3 text-right">
      <button id="import-paste-btn" class="chip bg-sky-500 text-white">Importar JSON</button>
    </div>

    <hr class="my-3">

    <div class="font-semibold mb-2">Planes guardados localmente</div>
    <div id="local-plans-list" class="bg-gray-100 border rounded p-2 max-h-48 overflow-auto text-sm"></div>

    <div class="text-right mt-3">
      <button id="list-local-btn" class="chip bg-white border">Refrescar</button>
    </div>
  </div>
</div>

<div id="toast" class="fixed bottom-4 right-4 hidden px-4 py-2 bg-sky-600 text-white rounded shadow"></div>
<script>
// =======================================================
// L√≥gica principal con: 
// 1. Eliminaci√≥n de d√≠as.
// 2. Selecci√≥n m√∫ltiple persistente en el cat√°logo.
// 3. FIX: Persistencia del estado de las secciones del cat√°logo (acorde√≥n).
// =======================================================

/* ---------- Config Firebase (ajusta si necesitas) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyD-w5QswIehqDGUohWReinNK5MXFW0C_Nw",
  authDomain: "rfa-2025.firebaseapp.com",
  projectId: "rfa-2025",
  storageBucket: "rfa-2025.firebasestorage.app",
  messagingSenderId: "113686586280",
  appId: "1:113686586280:web:223b4277f53ca0607c339d",
  measurementId: "G-T7F5V4WGY9"
};

/* ---------- Estado ---------- */
let db = null;
let auth = null;
let user = null;

const state = {
  planId: null,
  planData: null,
  days: [],
  activeDay: null,
  exercisesByDay: {},
  catalog: [],
  groups: [],
  pending: null,
  duplicate: null,
  // Para selecci√≥n m√∫ltiple en cat√°logo (PERSISTENTE)
  selectedCatalogItems: new Map(), // key: item.id, value: item
  // FIX: Para mantener abierto el acorde√≥n del cat√°logo
  openCatalogGroups: new Set(),
};

/* ---------- Helpers DOM ---------- */
const $ = id => document.getElementById(id);
function toast(msg, type='info') {
  const t = $('toast');
  t.textContent = msg;
  t.classList.remove('hidden');
  if (type === 'error') t.style.background = '#dc2626';
  else if (type === 'success') t.style.background = '#16a34a';
  else t.style.background = '#0ea5e9';
  setTimeout(()=> t.classList.add('hidden'), 2400);
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Helper: obtiene n√∫mero o null si vac√≠o
function getNumberOrNull(id){
  const el = $(id);
  if(!el) return null;
  const v = String(el.value ?? '').trim();
  if(v === '') return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

// Helper: limpiar campos del modal de configuraci√≥n
function clearConfigureInputs(){
  $('cfg-series').value = '';
  $('cfg-reps').value = '';
  $('cfg-time').value = '';
  $('cfg-time-unit').value = 'min';
  $('cfg-weight').value = '';
  $('cfg-weight-unit').value = 'kg';
  $('cfg-notes').value = '';
}

/* ---------- CATALOG LOAD (espera catalogo.js en la misma carpeta) ---------- */
function loadCatalog(){
  try {
    const arr = window.exerciseCatalog || [];
    state.catalog = arr.map((e,i)=>({
      id: e.id || `ex-${i}-${(e.nombre||e.name||'').replace(/\s+/g,'_')}`,
      name: e.nombre || e.name || '',
      group: (e.grupo || e.group || 'General').trim(),
      gif: e.gif || e.gifUrl || '',
      metodo: e.metodo || e.description || ''
    }));
    const g = new Set(state.catalog.map(c=>c.group||'General'));
    state.groups = Array.from(g).sort();
  } catch(e){
    console.error('loadCatalog error', e);
    state.catalog = [];
    state.groups = [];
  }
}

/* ---------- Local storage fallback ---------- */
function localKey(pid){ return `plan_local__${pid}`; }
function saveLocal(pid, data){ try{ localStorage.setItem(localKey(pid), JSON.stringify(data)); return true;}catch(e){ return false; } }
function loadLocal(pid){ try{ const s = localStorage.getItem(localKey(pid)); return s ? JSON.parse(s) : null; }catch(e){ return null; } }
function listLocalPlans(){
  const out = [];
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if (k && k.startsWith('plan_local__')){
      try {
        const p = JSON.parse(localStorage.getItem(k));
        out.push({ id: k.replace('plan_local__',''), name: p.name || '(sin nombre)', days: p.days || [] });
      } catch(e){}
    }
  }
  return out;
}

/* ---------- Firestore helper (se carga si internet y config ok) ---------- */
function planRef(){
  if (!db || !state.planId) return null;
  try {
    return firebase.firestore ? firebase.firestore().doc(`planes/${state.planId}`) : null;
  } catch(e){
    return null;
  }
}

/* ---------- Init UI & App ---------- */
async function init(){
  // planId from URL
  const params = new URLSearchParams(window.location.search);
  const pid = params.get('planId') || params.get('id');
  if (!pid) {
    toast('Falta planId en URL', 'error');
    return;
  }
  state.planId = pid;

  // load catalog
  loadCatalog();

  // try Firebase (use modular or fallback) - try to initialize firebase if available
  try {
    if (window.firebase && firebase.initializeApp) {
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
      } catch(e){
        console.warn('Firebase init skipped or failed', e);
        db = null;
      }
    }
  } catch(e){
    console.warn('Firebase not available', e);
    db = null;
  }

  // bind UI events
  bindUI();

  // auth/listen or local
  if (!db) {
    listenPlanLocal();
  } else {
    listenPlanFirestore();
  }

  renderCatalog();
}

/* ---------- UI Binding ---------- */
function bindUI(){
  $('btn-open-catalog').addEventListener('click', ()=>{ openCatalog(); });
  // NOTA: Estos cierres NO limpian la selecci√≥n, lo cual permite la persistencia.
  $('catalog-close').addEventListener('click', ()=>{ closeCatalog(); });
  $('catalog-cancel').addEventListener('click', ()=>{ closeCatalog(); });
  $('catalog-filter').addEventListener('input', ()=>{ renderCatalog(); });
  // A√±adir m√∫ltiples del cat√°logo
  $('catalog-add-multiple').addEventListener('click', ()=>{ finalizeMultipleConfigure(); });

  $('cfg-close').addEventListener('click', ()=>{ closeConfigure(); });
  $('cfg-cancel').addEventListener('click', ()=>{ closeConfigure(); });
  $('cfg-add').addEventListener('click', ()=>{ finalizeConfigure(); });

  $('btn-add-day').addEventListener('click', ()=>{ addDay(); });
  $('btn-import').addEventListener('click', ()=>{ openImport(); });

  $('import-close').addEventListener('click', ()=>{ closeImport(); });
  $('import-paste-btn').addEventListener('click', ()=>{ importPastedJSON(); });
  $('list-local-btn').addEventListener('click', ()=>{ renderLocalPlansList(); });

  $('btn-save-all').addEventListener('click', ()=>{ saveAndReturn(); });

  $('dup-no').addEventListener('click', ()=>{ state.duplicate=null; closeDuplicate(); toast('Cancelado','info'); });
  $('dup-yes').addEventListener('click', ()=>{ confirmDuplicateAdd(); });

  $('gif-close').addEventListener('click', ()=>{ closeGif(); });
}

/* ---------- Listen plan (local fallback) ---------- */
function listenPlanLocal(){
  const local = loadLocal(state.planId);
  if (local) {
    state.planData = local;
    state.days = Array.isArray(local.days) && local.days.length ? local.days.slice() : ['D√≠a 1'];
    state.exercisesByDay = Object.assign({}, local.exercisesByDay || {});
    state.days.forEach(d=>{ if (!state.exercisesByDay[d]) state.exercisesByDay[d]=[]; });
    state.activeDay = state.days[0];
    renderDays();
    renderExercises();
    toast('Plan cargado desde local', 'info');
    return;
  }
  // create default
  const initial = { name: `Plan ${state.planId}`, days: ['D√≠a 1'], exercisesByDay: { 'D√≠a 1': [] }, description: '' };
  state.planData = initial;
  state.days = initial.days.slice();
  state.exercisesByDay = Object.assign({}, initial.exercisesByDay);
  state.activeDay = 'D√≠a 1';
  saveLocal(state.planId, initial);
  renderDays();
  renderExercises();
}

/* ---------- Listen Firestore (if available) ---------- */
function listenPlanFirestore(){
  if (!db) { listenPlanLocal(); return; }
  listenPlanLocal(); // safe fallback to local in this environment
}

/* ---------- DAYS UI ---------- */
function renderDays(){
  const container = $('days-row');
  container.innerHTML = '';
  state.days.forEach(d=>{
    const btn = document.createElement('button');
    btn.className = `chip day-chip ${d === state.activeDay ? 'bg-sky-500 text-white' : 'bg-white border'}`;
    
    // Contenedor del nombre del d√≠a (para la funcionalidad del click)
    const dayName = document.createElement('span');
    dayName.innerText = d;
    dayName.onclick = ()=>{ state.activeDay = d; renderDays(); renderExercises(); };
    btn.appendChild(dayName);

    // Bot√≥n de eliminar d√≠a (üóëÔ∏è)
    if (state.days.length > 1) { // No permitir eliminar el √∫ltimo d√≠a
      const btnDelete = document.createElement('button');
      btnDelete.className = 'day-delete';
      btnDelete.innerHTML = 'üóëÔ∏è'; 
      btnDelete.title = `Eliminar ${d}`;
      btnDelete.onclick = (ev)=>{ ev.stopPropagation(); deleteDay(d); };
      btn.appendChild(btnDelete);
    }
    
    container.appendChild(btn);
  });
  $('days-count').innerText = `${state.days.length} d√≠a(s)`;
}

async function addDay(){
  if (state.days.length >= 7) { toast('M√°x 7 d√≠as', 'error'); return; }
  let maxN = 0;
  state.days.forEach(d => {
    const m = d.match(/D[i√≠]a\s*(\d+)/i);
    if (m) maxN = Math.max(maxN, parseInt(m[1],10));
  });
  const newN = maxN + 1 || state.days.length + 1;
  const newDay = `D√≠a ${newN}`;
  state.days.push(newDay);
  state.exercisesByDay[newDay] = [];
  state.activeDay = newDay;
  renderDays();
  renderExercises();
  await savePlan();
  toast(`D√≠a ${newN} agregado`, 'success');
}

// FUNCI√ìN: Eliminar D√≠a
async function deleteDay(dayToRemove){
  if (state.days.length <= 1) {
    toast('No puedes eliminar el √∫nico d√≠a restante.', 'error');
    return;
  }
  if (!confirm(`¬øEst√°s seguro de que quieres eliminar "${dayToRemove}"? Esto eliminar√° todos sus ejercicios.`)) return;

  const index = state.days.indexOf(dayToRemove);
  if (index === -1) return;

  state.days.splice(index, 1);
  delete state.exercisesByDay[dayToRemove];

  if (state.activeDay === dayToRemove) {
    state.activeDay = state.days[0]; // Seleccionar el primer d√≠a restante
  }

  renderDays();
  renderExercises();
  await savePlan();
  toast(`D√≠a ${dayToRemove} eliminado`, 'success');
}


/* ---------- EXERCISES LIST ---------- */
function renderExercises(){
  $('active-day-title').innerText = `Ejercicios para: ${state.activeDay || 'D√≠a 1'}`;
  const root = $('ex-list');
  root.innerHTML = '';
  const arr = state.exercisesByDay[state.activeDay] || [];
  if (!arr.length) {
    root.innerHTML = `<div class="text-gray-500 p-3 bg-gray-50 rounded">No hay ejercicios en este d√≠a.</div>`;
    return;
  }
  arr.forEach((ex, idx) => {
    const row = document.createElement('div');
    row.className = 'flex items-start gap-3 p-3 border rounded cursor-pointer';
    // img
    const img = document.createElement('img');
    img.src = ex.gif || '';
    img.alt = ex.name || '';
    img.className = 'w-20 h-16 object-contain rounded';
    img.onclick = (ev)=>{ ev.stopPropagation(); openGif(ex.gif, ex.name); };
    // info
    const info = document.createElement('div'); info.className = 'flex-1';
    const title = document.createElement('div'); title.className = 'font-semibold'; title.innerText = ex.name;

    // MOSTRAR DETALLES COMPLETOS
    const details = document.createElement('div');
    details.className = 'text-gray-500 text-sm mt-1';
    const seriesText = (ex.series === null || ex.series === undefined || ex.series === 0) ? '-' : ex.series;
    const repsText   = (ex.reps === null || ex.reps === undefined || ex.reps === 0) ? '-' : ex.reps;
    const timeText   = (ex.time === null || ex.time === undefined || ex.time === 0) ? '-' : `${ex.time} ${ex.timeUnit || ''}`.trim();
    const weightText = (ex.weight === null || ex.weight === undefined || ex.weight === 0) ? '-' : `${ex.weight} ${ex.weightUnit || ''}`.trim();
    const notesText  = ex.notes ? ex.notes : '-';

    details.innerHTML = `
      <div><strong>Series:</strong> ${seriesText} &nbsp; <strong>Reps:</strong> ${repsText}</div>
      <div><strong>Tiempo:</strong> ${timeText} &nbsp; <strong>Peso:</strong> ${weightText}</div>
      <div style="margin-top:6px;"><strong>Notas:</strong> ${escapeHtml(notesText)}</div>
    `;

    info.appendChild(title); info.appendChild(details);
    // controls
    const controls = document.createElement('div'); controls.className = 'flex flex-col gap-2';
    const btnEdit = document.createElement('button'); btnEdit.className = 'chip bg-white border'; btnEdit.innerText = 'Editar';
    btnEdit.onclick = (ev)=>{ ev.stopPropagation(); openConfigureForExisting(idx); };
    const btnUp = document.createElement('button'); btnUp.className = 'chip bg-white border'; btnUp.innerText = '‚Üë';
    btnUp.onclick = (ev)=>{ ev.stopPropagation(); moveExercise(idx, 'up'); };
    const btnDown = document.createElement('button'); btnDown.className = 'chip bg-white border'; btnDown.innerText = '‚Üì';
    btnDown.onclick = (ev)=>{ ev.stopPropagation(); moveExercise(idx,'down'); };
    const btnDel = document.createElement('button'); btnDel.className = 'chip bg-white border text-red-500'; btnDel.innerText = 'Eliminar';
    btnDel.onclick = (ev)=>{ ev.stopPropagation(); deleteExercise(idx); };
    controls.appendChild(btnEdit); controls.appendChild(btnUp); controls.appendChild(btnDown); controls.appendChild(btnDel);

    row.appendChild(img); row.appendChild(info); row.appendChild(controls);
    root.appendChild(row);
  });
}

/* ---------- Move / Delete ---------- */
async function moveExercise(i, dir){
  const arr = state.exercisesByDay[state.activeDay] || [];
  const j = dir === 'up' ? i-1 : i+1;
  if (j < 0 || j >= arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
  state.exercisesByDay[state.activeDay] = arr;
  renderExercises();
  await savePlan();
}
async function deleteExercise(i){
  const arr = state.exercisesByDay[state.activeDay] || [];
  arr.splice(i,1);
  state.exercisesByDay[state.activeDay] = arr;
  renderExercises();
  await savePlan();
}

// Nuevo Helper para abrir/cerrar grupos del cat√°logo (FIX principal)
function toggleCatalogGroup(groupName) {
    if (state.openCatalogGroups.has(groupName)) {
        state.openCatalogGroups.delete(groupName);
    } else {
        state.openCatalogGroups.add(groupName);
    }
    renderCatalog(); // Re-render para reflejar el estado sin que se cierre
}

/* ---------- CATALOG RENDER (ACORDE√ìN) - MODIFICADO PARA SELECCI√ìN M√öLTIPLE y PERSISTENCIA DE ACORDE√ìN ---------- */
function renderCatalog(){
  const root = $('catalog-root');
  root.innerHTML = '';
  const q = ($('catalog-filter').value || '').toLowerCase();
  
  // Actualizar el contador del bot√≥n de a√±adir m√∫ltiples
  const count = state.selectedCatalogItems.size;
  const btnMultiple = $('catalog-add-multiple');
  btnMultiple.innerText = `A√±adir seleccionados (${count})`;
  btnMultiple.disabled = count === 0;


  state.groups.forEach(group => {
    const items = state.catalog.filter(c => c.group === group && (c.name.toLowerCase().includes(q) || c.group.toLowerCase().includes(q)));
    if (!items.length) return;
    const section = document.createElement('div'); section.className = 'border rounded mb-3';
    const header = document.createElement('button'); header.className = 'w-full text-left px-3 py-2 bg-gray-50 flex items-center justify-between';
    header.innerHTML = `<span class="font-semibold">${escapeHtml(group)}</span><span class="text-gray-500 text-sm">${items.length}</span>`;
    
    // FIX: Usar el estado de openCatalogGroups
    const isOpen = state.openCatalogGroups.has(group);
    const list = document.createElement('div'); 
    list.className = `p-2 space-y-2 ${isOpen ? '' : 'hidden'}`;

    // FIX: Usar el nuevo helper para manejar el estado del acorde√≥n
    header.addEventListener('click', ()=>{ toggleCatalogGroup(group); }); 

    items.forEach(c => {
      const isSelected = state.selectedCatalogItems.has(c.id);
      const row = document.createElement('div'); 
      row.className = `flex items-center gap-3 p-2 rounded hover:bg-gray-50 cursor-pointer ${isSelected ? 'bg-sky-100 border border-sky-400' : ''}`;
      
      row.onclick = ()=> toggleCatalogSelection(c); // Ahora el click en la fila lo selecciona/deselecciona
      
      const img = document.createElement('img'); img.src = c.gif || ''; img.className = 'w-20 h-14 object-contain rounded';
      const info = document.createElement('div'); info.className = 'flex-1';
      const nm = document.createElement('div'); nm.className = 'font-medium'; nm.innerText = c.name;
      const mtd = document.createElement('div'); mtd.className = 'text-gray-500 text-xs'; mtd.innerText = c.metodo ? (c.metodo.slice(0,80) + (c.metodo.length>80 ? '...' : '')) : '';
      info.appendChild(nm); info.appendChild(mtd);
      
      // Bot√≥n para seleccionar/quitar
      const btn = document.createElement('button');
      btn.className = `chip ${isSelected ? 'bg-white border text-red-500' : 'bg-sky-500 text-white'}`; 
      btn.innerText = isSelected ? 'Quitar (-)' : 'A√±adir (+)';
      btn.onclick = (ev)=>{ ev.stopPropagation(); toggleCatalogSelection(c); };
      
      row.appendChild(img); row.appendChild(info); row.appendChild(btn);
      list.appendChild(row);
    });
    section.appendChild(header); section.appendChild(list); root.appendChild(section);
  });
}

// FUNCI√ìN: Seleccionar/Deseleccionar
function toggleCatalogSelection(item){
  if (state.selectedCatalogItems.has(item.id)) {
    state.selectedCatalogItems.delete(item.id);
  } else {
    // A√±adimos con los valores por defecto
    state.selectedCatalogItems.set(item.id, {
        ...item,
        series: null, reps: null, time: null, weight: null,
        timeUnit: 'min', weightUnit: 'kg', notes: ''
    });
  }
  renderCatalog(); // Volver a renderizar. Gracias al FIX, la secci√≥n no se cerrar√°.
}

/* Open / Close catalog (NO limpia la selecci√≥n para permitir persistencia) */
function openCatalog(){ 
  $('catalog-modal').style.display='flex'; 
  $('overlay').style.display='block'; 
  // No limpiar state.selectedCatalogItems
  renderCatalog(); 
  $('catalog-filter').focus(); 
}
function closeCatalog(){ 
  $('catalog-modal').style.display='none'; 
  $('overlay').style.display='none'; 
  $('catalog-filter').value = ''; 
  // No limpiar state.selectedCatalogItems o state.openCatalogGroups
}

// FUNCI√ìN: Finalizar y agregar m√∫ltiples
async function finalizeMultipleConfigure(){
  if (state.selectedCatalogItems.size === 0) {
    toast('No hay ejercicios seleccionados.', 'error');
    return;
  }
  
  const arr = state.exercisesByDay[state.activeDay] || [];
  let addedCount = 0;
  
  state.selectedCatalogItems.forEach(item => {
    // Omitimos duplicados
    const isDuplicate = arr.some(e => e.id === item.id);
    if (!isDuplicate) {
      // Usamos los valores predeterminados (null o vac√≠os)
      const entry = {
        id: item.id,
        name: item.name,
        group: item.group,
        gif: item.gif,
        series: null, reps: null, time: null, weight: null,
        weightUnit: 'kg', timeUnit: 'min', notes: ''
      };
      arr.push(entry);
      addedCount++;
    }
  });

  state.exercisesByDay[state.activeDay] = arr;
  renderExercises();
  await savePlan();
  
  // Limpiar selecci√≥n SOLAMENTE DESPU√âS DE AGREGAR y renderizar
  state.selectedCatalogItems = new Map();
  renderCatalog();
  
  // Cerrar el modal despu√©s de a√±adir
  closeCatalog(); 
  toast(`${addedCount} ejercicios a√±adidos. Edita cada uno para configurar series/reps.`, 'success');
}


/* ---------- Configure flow (para editar o a√±adir uno a uno con detalle) ---------- */
// NOTA: Esta funci√≥n ahora solo se usa para editar un ejercicio existente.
function openConfigureForExisting(index){
  const arr = state.exercisesByDay[state.activeDay] || [];
  const it = arr[index];
  if (!it) return;
  state.pending = {...it, existingIndex: index};
  $('cfg-name').innerText = it.name;
  $('cfg-group').innerText = it.group || '';
  $('cfg-gif').src = it.gif || '';
  // Si vienen valores, los mostramos; si no, dejamos vac√≠o
  $('cfg-series').value = (it.series === null || it.series === undefined) ? '' : it.series;
  $('cfg-reps').value = (it.reps === null || it.reps === undefined) ? '' : it.reps;
  $('cfg-weight').value = (it.weight === null || it.weight === undefined) ? '' : it.weight;
  $('cfg-weight-unit').value = it.weightUnit || 'kg';
  $('cfg-time').value = (it.time === null || it.time === undefined) ? '' : it.time;
  $('cfg-time-unit').value = it.timeUnit || 'min';
  $('cfg-notes').value = it.notes || '';
  
  const cfgAddBtn = $('cfg-add');
  cfgAddBtn.innerText = 'Actualizar';
  
  openConfigure();
}
// openConfigureFromCatalog (flujo antiguo, no se usa con selecci√≥n m√∫ltiple)
function openConfigureFromCatalog(item){
  state.pending = {...item, existingIndex: undefined};
  $('cfg-name').innerText = item.name;
  $('cfg-group').innerText = item.group || '';
  $('cfg-gif').src = item.gif || '';
  clearConfigureInputs();
  closeCatalog();
  
  const cfgAddBtn = $('cfg-add');
  cfgAddBtn.innerText = 'Agregar';
  
  openConfigure();
}

function openConfigure(){ $('configure-modal').style.display='flex'; $('overlay').style.display='block'; }
function closeConfigure(){ $('configure-modal').style.display='none'; $('overlay').style.display='none'; state.pending = null; }

/* ---------- Finalize configure (add/update) ---------- */
async function finalizeConfigure(){
  if (!state.pending) return closeConfigure();

  // Tomamos valores num√©ricos o null si vac√≠o
  const entry = {
    id: state.pending.id,
    name: state.pending.name,
    group: state.pending.group,
    gif: state.pending.gif,
    series: getNumberOrNull('cfg-series'),
    reps: getNumberOrNull('cfg-reps'),
    weight: getNumberOrNull('cfg-weight'),
    weightUnit: $('cfg-weight-unit').value || 'kg',
    time: getNumberOrNull('cfg-time'),
    timeUnit: $('cfg-time-unit').value || 'min',
    notes: $('cfg-notes').value || ''
  };

  const arr = state.exercisesByDay[state.activeDay] || [];
  if (typeof state.pending.existingIndex === 'number'){
    // --- ACTUALIZAR ---
    arr[state.pending.existingIndex] = entry;
    state.exercisesByDay[state.activeDay] = arr;
    renderExercises();
    await savePlan();
    closeConfigure();
    toast('Ejercicio actualizado', 'success');
    return;
  }
  
  // --- AGREGAR (solo si se llama desde openConfigureFromCatalog) ---

  // duplicate check
  if (arr.some(e => e.id === entry.id)){
    state.duplicate = { entry, day: state.activeDay };
    openDuplicate();
    return;
  }

  arr.push(entry);
  state.exercisesByDay[state.activeDay] = arr;
  renderExercises();
  await savePlan();
  // limpiar inputs despu√©s de agregar 
  clearConfigureInputs();
  closeConfigure();
  toast('Ejercicio agregado', 'success');
}

/* Duplicate modal */
function openDuplicate(){ $('duplicate-modal').style.display='flex'; $('overlay').style.display='block'; }
function closeDuplicate(){ $('duplicate-modal').style.display='none'; $('overlay').style.display='none'; state.duplicate = null; }
async function confirmDuplicateAdd(){
  if (!state.duplicate) return closeDuplicate();
  const { entry, day } = state.duplicate;
  const arr = state.exercisesByDay[day] || [];
  arr.push(entry);
  state.exercisesByDay[day] = arr;
  await savePlan();
  closeDuplicate();
  closeConfigure();
  renderExercises();
  toast('Duplicado a√±adido', 'success');
}

/* GIF modal */
function openGif(url, title){
  $('gif-large').src = url || '';
  $('gif-title').innerText = title || '';
  $('gif-modal').style.display = 'flex';
  $('overlay').style.display = 'block';
}
function closeGif(){ $('gif-modal').style.display='none'; $('overlay').style.display='none'; }

/* ---------- IMPORT modal functions ---------- */
function openImport(){ $('import-modal').style.display='flex'; $('overlay').style.display='block'; renderLocalPlansList(); }
function closeImport(){ $('import-modal').style.display='none'; $('overlay').style.display='none'; }

function renderLocalPlansList(){
  const box = $('local-plans-list');
  const list = listLocalPlans();
  if (!list.length) { box.innerHTML = '<div class="text-gray-500">No hay planes locales guardados.</div>'; return; }
  box.innerHTML = list.map(p=>{
    return `<div class="p-2 border-b flex justify-between items-center"><div><div class="font-semibold">${escapeHtml(p.name)}</div><div class="text-gray-500 text-xs">${(p.days||[]).join(', ')}</div></div><div><button class="chip bg-white border" onclick="importLocalPlan('${p.id}')">Importar</button></div></div>`;
  }).join('');
}
window.importLocalPlan = async function(pid){
  const data = loadLocal(pid);
  if (!data){ toast('Plan no encontrado', 'error'); return; }
  const curDays = state.days.slice();
  const srcDays = Array.isArray(data.days) ? data.days : [];
  const merged = Array.from(new Set([...curDays, ...srcDays])).slice(0,7);
  const mergedEx = Object.assign({}, state.exercisesByDay || {});
  (srcDays||[]).forEach(d=>{
    const srcArr = data.exercisesByDay && data.exercisesByDay[d] ? data.exercisesByDay[d] : [];
    if (!mergedEx[d] || mergedEx[d].length===0) mergedEx[d] = srcArr.slice();
    else {
      const exist = new Set(mergedEx[d].map(e=>e.id));
      const nonDup = srcArr.filter(e=>!exist.has(e.id));
      mergedEx[d] = [...mergedEx[d], ...nonDup];
    }
  });
  state.days = merged;
  state.exercisesByDay = mergedEx;
  state.activeDay = state.days[0];
  renderDays();
  renderExercises();
  await savePlan();
  closeImport();
  toast('Plan importado (local)', 'success');
};

async function importPastedJSON(){
  const txt = $('import-paste').value.trim();
  if (!txt){ toast('Pega JSON', 'error'); return; }
  try {
    const data = JSON.parse(txt);
    if (!Array.isArray(data.days) || !data.exercisesByDay){ toast('JSON inv√°lido', 'error'); return; }
    const curDays = state.days.slice();
    const srcDays = data.days;
    const merged = Array.from(new Set([...curDays, ...srcDays])).slice(0,7);
    const mergedEx = Object.assign({}, state.exercisesByDay || {});
    srcDays.forEach(d=>{
      const srcArr = data.exercisesByDay && data.exercisesByDay[d] ? data.exercisesByDay[d] : [];
      if (!mergedEx[d] || mergedEx[d].length===0) mergedEx[d] = srcArr.slice();
      else {
        const exist = new Set(mergedEx[d].map(e=>e.id));
        const nonDup = srcArr.filter(e=>!exist.has(e.id));
        mergedEx[d] = [...mergedEx[d], ...nonDup];
      }
    });
    state.days = merged;
    state.exercisesByDay = mergedEx;
    state.activeDay = state.days[0];
    renderDays();
    renderExercises();
    await savePlan();
    closeImport();
    toast('Plan importado (JSON)', 'success');
  } catch(e){ console.error(e); toast('JSON inv√°lido', 'error'); }
}

/* ---------- SAVE PLAN (Firestore attempt, else local) ---------- */
async function savePlan(){
  // payload
  const payload = {
    name: state.planData?.name || `Plan ${state.planId}`,
    days: state.days,
    exercisesByDay: state.exercisesByDay,
    description: state.planData?.description || ''
  };

  // Try Firestore (if db configured)
  if (db && window.firebase && firebase.firestore) {
    try {
      const ref = firebase.firestore().doc(`planes/${state.planId}`);
      await ref.set(payload, { merge: true });
      saveLocal(state.planId, payload);
      return;
    } catch(e){
      console.warn('Firestore save failed, saving local', e);
    }
  }

  // Fallback local
  saveLocal(state.planId, payload);
}

/* ---------- SAVE & RETURN (redirect to ejercicios.html) ---------- */
async function saveAndReturn(){
  await savePlan();
  toast('Guardado. Redirigiendo...', 'success');
  setTimeout(()=>{
    // redirect to ejercicios.html in same folder
    window.location.href = 'ejercicios.html';
  }, 800);
}

/* ---------- Boot ---------- */
loadCatalog();
init();

</script>
<script>
(function(){
  // Intenta cargar catalogo.js desde la misma carpeta
  const script = document.createElement('script');
  script.src = 'catalogo.js';
  script.onload = function(){
    console.info('catalogo.js cargado correctamente.');
    // Si las funciones existen, actualiza el cat√°logo y renderiza
    try {
      if (typeof loadCatalog === 'function') loadCatalog();
      if (typeof renderCatalog === 'function') renderCatalog();
      if (typeof renderDays === 'function') renderDays();
      if (typeof renderExercises === 'function') renderExercises();
    } catch(e){ console.warn('Error al refrescar UI tras cargar cat√°logo', e); }
  };
  script.onerror = function(){
    console.warn('catalogo.js no encontrado en la misma carpeta (catalogo.js). Comprueba que exista.');
    // aun as√≠ forzamos render para evitar UI vac√≠a
    try { if (typeof renderCatalog === 'function') renderCatalog(); } catch(e){}
  };
  document.head.appendChild(script);
})();
</script>

</body>
</html>
