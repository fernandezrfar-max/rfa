<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Pacientes</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">

  <style>
    /* Fuente global */
    * { font-family: 'Poppins', sans-serif !important; font-weight: 600 !important; box-sizing: border-box; }
    body { margin: 0; background: #f6f6f6; color:#222; }

    header { background: #009688; color: #fff; padding: 15px; text-align: center; font-size: 22px; position: sticky; top: 0; z-index: 10; }

    .container { padding: 20px; padding-bottom: 140px; }

    .search-box { background: #e8f2ff; padding: 15px; border-radius: 30px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .search-box input { border: none; background: transparent; width: 100%; font-size: 16px; }
    .search-icon { font-size: 20px; opacity: 0.6; }

    .empty-text { text-align: center; color: #777; margin-top: 40px; font-size: 18px; }

    #listaPacientes { margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap: 12px; }
    .paciente-card {
      display:flex; align-items:center; gap:12px;
      padding:14px; background:#fff; border-radius:14px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08); cursor:pointer;
      transition: transform .12s ease;
    }
    .paciente-card:hover { transform: translateY(-4px); }
    .paciente-card img { width:56px; height:56px; border-radius:50%; object-fit:cover; background:#ddd; }
    .paciente-info h3 { margin:0; font-size:16px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
    .paciente-info p { margin:4px 0 0 0; color:#666; font-size:13px; }

    .floating-btn { position: fixed; bottom: 90px; right: 25px; background: #1e88e5; color: white; padding: 16px 22px; border-radius: 25px; font-size: 18px; display: flex; align-items: center; gap: 8px; cursor: pointer; box-shadow: 0 6px 18px rgba(0,0,0,0.18); z-index: 40; }

    /* MODAL REDISE√ëADO (Cards limpias) */
    .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.45); display: none; justify-content: center; align-items: flex-start; z-index: 50; padding: 20px 0; overflow-y: auto; }
    .modal { background: #fff; width: 96%; max-width: 820px; padding: 20px; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); margin: auto; max-height: 90vh; overflow-y: auto; }
    .modal h3 { margin-top: 0; font-size: 20px; color: #222; }

    /* layout de detalle */
    .detalle-grid { display: grid; grid-template-columns: 160px 1fr; gap: 18px; align-items:start; }
    .foto-grande { width: 160px; height:160px; border-radius:12px; object-fit:cover; background:#eee; display:block; }
    .info-card, .planes-card, .notas-card { background:#f7fbfb; padding:12px; border-radius:10px; border: 1px solid rgba(0,0,0,0.04); }
    .info-row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:8px; }
    .info-row .label { width:120px; color:#666; font-size:13px; }
    .info-row .value { color:#111; font-size:15px; }

    .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip { background:#e0f2f1; padding:8px 10px; border-radius:20px; font-size:13px; display:flex; gap:8px; align-items:center; color:#004d40; }
    .chip .close { background:transparent; border:none; font-weight:700; cursor:pointer; color:#004d40; }

    .small-note { color:#555; font-size:13px; margin-top:6px; }

    /* CAMBIO: Alineaci√≥n del footer para mostrar el bot√≥n de eliminar a la izquierda */
    .modal-footer {
        display:flex;
        justify-content: space-between;
        gap:12px;
        margin-top:14px;
    }
    .modal-footer-right { display: flex; gap: 12px; }

    .btn { padding:10px 14px; border-radius:10px; cursor:pointer; border:none; font-weight:600; }
    .btn.secondary { background:transparent; color:#00796b; }
    .btn.primary { background:#1e88e5; color:#fff; }
    /* NUEVO ESTILO DE BOT√ìN DE ELIMINAR */
    .btn.danger { background: #e53935; color: #fff; }

    /* panel editor de planes dentro del modal */
    .planes-editor { margin-top:10px; background:#fff; border:1px solid #eee; padding:10px; border-radius:8px; max-height:220px; overflow:auto; }
    .plan-item { display:flex; align-items:center; gap:10px; padding:8px; border-radius:6px; }
    .plan-item label { cursor:pointer; }

    /* responsive */
    @media (max-width:700px) {
      .detalle-grid { grid-template-columns: 1fr; }
      .foto-grande { margin: 0 auto; }
    }

    /* NAV INFERIOR */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -3px 10px rgba(0,0,0,0.06); z-index: 20; }
    .nav-item { text-align: center; color: #00695c; font-size: 14px; text-decoration: none; }
    .nav-item img { width: 22px; opacity: 0.8; }
  </style>
</head>

<body>
  <header>Gesti√≥n de Pacientes</header>

  <div class="container">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input id="buscador" type="text" placeholder="Buscar paciente por nombre..." />
    </div>

    <div id="listaPacientes"></div>
    <p id="noPacientes" class="empty-text">No hay pacientes registrados a√∫n.</p>
  </div>

  <div class="floating-btn" onclick="abrirModalAgregar()">
    + Nuevo Paciente
  </div>

  <div class="modal-bg" id="modalBg">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Agregar nuevo paciente</h3>

      <div class="detalle-grid">
        <div style="text-align:center;">
          <img id="photoPreview" class="foto-grande" src="https://via.placeholder.com/160?text=Perfil" alt="Foto perfil">
          <input id="inputFotoURL" type="text" placeholder="URL foto (opcional)" style="width:100%; margin-top:8px; border-radius:8px; padding:8px; border:1px solid #ddd;">
          <div class="small-note">Pega un link de imagen v√°lido</div>
        </div>

        <div>
          <div class="info-card">
            <div class="info-row"><div class="label">Nombre</div><div class="value"><input id="nombre" type="text" placeholder="Nombre completo" style="width:100%; border:none; background:transparent; font-weight:600; font-size:16px;"></div></div>
            <div class="info-row"><div class="label">Correo</div><div class="value"><input id="correo" type="email" placeholder="Correo" style="width:100%; border:none; background:transparent;"></div></div>
            <div class="info-row">
              <div class="label">Edad</div>
              <div class="value"><input id="edad" type="number" placeholder="Edad" style="width:80px; border:none; background:transparent;"></div>
              <div class="label" style="width:80px;">Altura (cm)</div>
              <div class="value"><input id="altura" type="number" placeholder="Altura" style="width:80px; border:none; background:transparent;"></div>
              <div class="label" style="width:70px;">Peso (kg)</div>
              <div class="value"><input id="peso" type="number" placeholder="Peso" style="width:80px; border:none; background:transparent;"></div>
            </div>
            <div class="info-row"><div class="label">Usuario</div><div class="value"><input id="usuario" type="text" placeholder="Usuario" style="width:100%; border:none; background:transparent;"></div></div>
            <div class="info-row"><div class="label">Contrase√±a</div><div class="value"><input id="contrasena" type="password" placeholder="Contrase√±a" style="width:100%; border:none; background:transparent;"></div></div>
          </div>

          <div class="planes-card" style="margin-top:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="font-weight:700;">Planes asignados</div>
              <div style="font-size:13px; color:#00796b; cursor:pointer;" id="toggleEditorBtn">‚úé Editar planes</div>
            </div>

            <div id="chipsArea" class="chips" style="margin-top:10px;">
              <div class="small-note">Sin planes asignados</div>
            </div>

            <div id="planesEditor" class="planes-editor" style="display:none; margin-top:10px;">
              <div class="small-note">Marca los planes que quieras asignar (puedes seleccionar varios)</div>
              <div id="planesContainer" style="margin-top:8px;"></div>
            </div>

            <button id="crearPlanBtn" class="btn" style="margin-top:10px; background:#009688; color:#fff; width:100%;" onclick="irACrearPlan()">+ Crear nuevo plan</button>
          </div>

          <div class="notas-card" style="margin-top:12px;">
            <div style="font-weight:700;">Observaciones</div>
            <textarea id="notas" rows="3" placeholder="Notas del paciente..." style="width:100%; border:none; background:transparent; margin-top:8px;"></textarea>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button id="eliminarBtn" class="btn danger" onclick="eliminarPaciente()" style="display:none;">Eliminar paciente</button>

        <div class="modal-footer-right">
            <button class="btn secondary" onclick="cerrarModal()">Cancelar</button>
            <button id="guardarBtn" class="btn primary" onclick="guardarPaciente()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <a href="admin_dashboard.html" class="nav-item">
      <img src="logo.png" alt="">
      <br>Dashboard
    </a>

    <a href="pacientes.html" class="nav-item">
      <img src="logo.png" alt="">
      <br>Pacientes
    </a>

    <a href="ejercicios.html" class="nav-item">
      <img src="logo.png" alt="" style="transform:rotate(45deg);">
      <br>Ejercicios
    </a>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <script>
    // CONFIG FIREBASE (mant√©n tus claves como estaban)
    const firebaseConfig = {
      apiKey: "AIzaSyD-w5QswIehqDGUohWReinNK5MXFW0C_Nw",
      authDomain: "rfa-2025.firebaseapp.com",
      projectId: "rfa-2025",
      storageBucket: "rfa-2025.firebasestorage.app",
      messagingSenderId: "113686586280",
      appId: "1:113686586280:web:223b4277f53ca0607c339d",
      measurementId: "G-T7F5V4WGY9"
    };

    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
    window.storage = firebase.storage();
  </script>

  <script>
    // Elementos
    const listaEl = document.getElementById('listaPacientes');
    const noPacientesEl = document.getElementById('noPacientes');
    const buscador = document.getElementById('buscador');

    const modalBg = document.getElementById('modalBg');
    const modalTitle = document.getElementById('modalTitle');
    const photoPreview = document.getElementById('photoPreview');

    const nombreIn = document.getElementById('nombre');
    const correoIn = document.getElementById('correo');
    const edadIn = document.getElementById('edad');
    const alturaIn = document.getElementById('altura');
    const pesoIn = document.getElementById('peso');
    const usuarioIn = document.getElementById('usuario');
    const contrasenaIn = document.getElementById('contrasena');
    const notasIn = document.getElementById('notas');
    const guardarBtn = document.getElementById('guardarBtn');
    // NUEVO ELEMENTO
    const eliminarBtn = document.getElementById('eliminarBtn');

    const inputFotoURL = document.getElementById('inputFotoURL');
    const planesContainer = document.getElementById('planesContainer');
    const chipsArea = document.getElementById('chipsArea');
    const planesEditor = document.getElementById('planesEditor');
    const toggleEditorBtn = document.getElementById('toggleEditorBtn');

    let modoEdicion = false;
    let idEdicion = null;
    let fotoActualUrl = "";

    // mapa local de planes
    const planesMap = {};

    // --- mecanismo elegante para saber cuando los planes han cargado al menos una vez ---
    let planesReadyResolve = null;
    let planesReadyResolved = false;
    const planesReady = new Promise((resolve) => { planesReadyResolve = resolve; });

    // preview foto desde URL
    inputFotoURL.addEventListener('input', () => {
      photoPreview.src = inputFotoURL.value.trim() || 'https://via.placeholder.com/160?text=Perfil';
    });

    // Abrir modal para agregar
    window.abrirModalAgregar = async () => {
      modoEdicion = false; idEdicion = null; fotoActualUrl = "";
      modalTitle.textContent = "Agregar nuevo paciente";
      // OCULTAR bot√≥n de eliminar
      eliminarBtn.style.display = 'none';

      photoPreview.src = 'https://via.placeholder.com/160?text=Perfil';
      inputFotoURL.value = "";
      nombreIn.value = correoIn.value = edadIn.value = alturaIn.value = pesoIn.value = usuarioIn.value = contrasenaIn.value = notasIn.value = "";

      // limpiar chips visuales
      renderChips([]);

      // esperar a que los planes est√©n listados (primera carga) para que los checkboxes existan
      try {
        await planesReady;
      } catch (e) { /* no pasa nada */ }

      // asegurarse de desmarcar todo
      Array.from(planesContainer.querySelectorAll('input[type="checkbox"]')).forEach(cb => cb.checked = false);

      planesEditor.style.display = 'none';
      modalBg.style.display = 'flex';
    };

    window.cerrarModal = () => { modalBg.style.display = 'none'; };

    // Guardar paciente
    window.guardarPaciente = async () => {
      guardarBtn.disabled = true;
      guardarBtn.textContent = 'Guardando...';
      try {
        const nombre = nombreIn.value.trim();
        if (!nombre) { alert('Ingresa el nombre'); guardarBtn.disabled = false; guardarBtn.textContent = 'Guardar'; return; }

        const correo = correoIn.value.trim();
        const edad = Number(edadIn.value) || null;
        const altura = Number(alturaIn.value) || null;
        const peso = Number(pesoIn.value) || null;
        const usuario = usuarioIn.value.trim();
        const contrasena = contrasenaIn.value;
        const notas = notasIn.value.trim();
        const fotoUrl = inputFotoURL.value.trim() || fotoActualUrl || '';

        // obtener planes seleccionados
        const checks = Array.from(planesContainer.querySelectorAll('input[type="checkbox"]'));
        const planesSeleccionados = checks.filter(c => c.checked).map(c => {
          const id = c.value;
          const p = planesMap[id] || {};
          return {
            id,
            nombre: p.nombre || p.title || 'Plan sin nombre',
            asignadoEn: new Date()
          };
        });

        if (modoEdicion && idEdicion) {
          await db.collection('pacientes').doc(idEdicion).update({
            nombre, correo, edad, altura, peso, usuario, contrasena, foto: fotoUrl,
            notas, planesAsignados: planesSeleccionados,
            actualizado: new Date()
          });
          alert('Paciente actualizado');
        } else {
          await db.collection('pacientes').add({
            nombre, correo, edad, altura, peso, usuario, contrasena, foto: fotoUrl,
            notas, planesAsignados: planesSeleccionados,
            creado: new Date()
          });
          alert('Paciente registrado correctamente');
        }

        cerrarModal();
      } catch (err) {
        console.error('Error al guardar paciente', err);
        alert('Hubo un error al guardar. Revisa la consola.');
      } finally {
        guardarBtn.disabled = false;
        guardarBtn.textContent = 'Guardar';
      }
    };

    // NUEVA FUNCI√ìN: Eliminar paciente
    window.eliminarPaciente = async () => {
        if (!modoEdicion || !idEdicion) return;

        const nombrePaciente = nombreIn.value.trim() || 'este paciente';

        if (!confirm(`¬øEst√°s seguro de que quieres eliminar permanentemente a ${nombrePaciente}? Esta acci√≥n es irreversible.`)) {
            return;
        }

        eliminarBtn.disabled = true;
        eliminarBtn.textContent = 'Eliminando...';

        try {
            await db.collection('pacientes').doc(idEdicion).delete();
            alert('Paciente eliminado correctamente.');
            cerrarModal();
        } catch (err) {
            console.error('Error al eliminar paciente:', err);
            alert('Hubo un error al eliminar. Revisa la consola.');
        } finally {
            eliminarBtn.disabled = false;
            eliminarBtn.textContent = 'Eliminar paciente';
        }
    };

    // Listener realtime para pacientes
    db.collection('pacientes').orderBy('nombre').onSnapshot((snap) => {
      listaEl.innerHTML = '';
      if (snap.empty) {
        noPacientesEl.style.display = 'block';
        return;
      }
      noPacientesEl.style.display = 'none';
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;
        const foto = d.foto || 'https://via.placeholder.com/120?text=Perfil';
        const card = document.createElement('div');
        card.className = 'paciente-card';
        card.innerHTML = `
          <img src="${foto}" alt="foto">
          <div class="paciente-info">
            <h3>${escapeHtml(d.nombre || 'Sin nombre')}</h3>
            <p class="small-note">${escapeHtml(d.usuario || '')}</p>
          </div>
        `;
        card.addEventListener('click', () => abrirModalEdicion(id));
        listaEl.appendChild(card);
      });
    }, (err) => { console.error('Error escuchando pacientes:', err); });

    // Cargar planes con onSnapshot para mantener actualizados
    function escucharPlanes() {
      db.collection('planes').onSnapshot((snap) => {
        // limpiar y renderizar
        planesMapClearAndRender(snap);
      }, (err) => {
        console.error('Error escuchando planes:', err);
        planesContainer.innerHTML = '<div class="small-note">No se pudieron cargar los planes.</div>';
        // resolver planesReady para no dejar bloqueado el modal si hay error
        if (!planesReadyResolved) {
          planesReadyResolved = true;
          planesReadyResolve();
        }
      });
    }

    function planesMapClearAndRender(snap) {
      planesContainer.innerHTML = '';
      Object.keys(planesMap).forEach(k => delete planesMap[k]);
      if (snap.empty) {
        planesContainer.innerHTML = '<div class="small-note">No hay planes creados todav√≠a.</div>';
        renderChips([]); // limpiar chips si no hay planes
      } else {
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          planesMap[id] = d;

          // item checkbox
          const item = document.createElement('div');
          item.className = 'plan-item';
          item.innerHTML = `
            <input type="checkbox" id="plan_${id}" value="${id}">
            <label for="plan_${id}">${escapeHtml(d.nombre || d.title || 'Plan sin nombre')}</label>
            <div style="margin-left:auto; font-size:12px; color:#666;">${Array.isArray(d.days) ? d.days.length+' d√≠as' : ''}</div>
          `;
          planesContainer.appendChild(item);

          // si alguien hace clic en checkbox, actualizamos chips en tiempo real
          const cb = item.querySelector('input[type=checkbox]');
          cb.addEventListener('change', () => {
            actualizarChipsDesdeCheckboxes();
          });
        });

        // sincronizar chips (si es edici√≥n los marcar√° despu√©s)
        actualizarChipsDesdeCheckboxes();
      }

      // resolver promise de ready la primera vez que tengamos un render (√©xito o vac√≠o)
      if (!planesReadyResolved) {
        planesReadyResolved = true;
        planesReadyResolve();
      }
    }

    // inicializamos escucha
    escucharPlanes();

    // abrir modal en modo edici√≥n
    async function abrirModalEdicion(id) {
      try {
        modoEdicion = true; idEdicion = id;
        modalTitle.textContent = "Detalles / Editar paciente";
        // MOSTRAR bot√≥n de eliminar
        eliminarBtn.style.display = 'block';

        const refDoc = db.collection('pacientes').doc(id);
        const snap = await refDoc.get();
        if (!snap.exists) { alert('El paciente no existe'); return; }

        const d = snap.data();

        nombreIn.value = d.nombre || '';
        correoIn.value = d.correo || '';
        edadIn.value = d.edad || '';
        alturaIn.value = d.altura || '';
        pesoIn.value = d.peso || '';
        usuarioIn.value = d.usuario || '';
        contrasenaIn.value = d.contrasena || '';
        notasIn.value = d.notas || '';
        fotoActualUrl = d.foto || '';
        photoPreview.src = fotoActualUrl || 'https://via.placeholder.com/160?text=Perfil';
        inputFotoURL.value = d.foto || "";

        // esperar a que los planes est√©n listados para poder marcar checkboxes correctamente
        try { await planesReady; } catch(e) {}

        // marcar checkboxes seg√∫n lo guardado (planesAsignados puede ser array de ids u objetos)
        const guardados = d.planesAsignados || [];
        const ids = new Set();
        guardados.forEach(p => { if (!p) return; if (typeof p === 'string') ids.add(p); else if (p.id) ids.add(p.id); });

        Array.from(planesContainer.querySelectorAll('input[type="checkbox"]')).forEach(cb => {
          cb.checked = ids.has(cb.value);
        });

        actualizarChipsDesdeCheckboxes();

        planesEditor.style.display = 'none';
        modalBg.style.display = 'flex';
      } catch (err) {
        console.error('Error abriendo edici√≥n:', err);
        alert('No se pudo abrir el paciente');
      }
    }

    // actualizar chips seg√∫n checkboxes
    function actualizarChipsDesdeCheckboxes() {
      const checks = Array.from(planesContainer.querySelectorAll('input[type="checkbox"]'));
      const seleccionados = checks.filter(c => c.checked).map(c => {
        const id = c.value;
        const p = planesMap[id] || {};
        return { id, nombre: p.nombre || p.title || 'Plan sin nombre' };
      });
      renderChips(seleccionados);
    }

    // renderizar chips (√°rea visual)
    function renderChips(arr) {
      chipsArea.innerHTML = '';
      if (!arr || arr.length === 0) {
        chipsArea.innerHTML = '<div class="small-note">Sin planes asignados</div>';
        return;
      }
      arr.forEach(p => {
        const el = document.createElement('div');
        el.className = 'chip';
        el.innerHTML = `<span>${escapeHtml(p.nombre)}</span><button class="close" title="Quitar" data-id="${p.id}">‚úï</button>`;
        chipsArea.appendChild(el);

        // quitar plan al pulsar la X -> desmarcar checkbox
        el.querySelector('.close').addEventListener('click', (ev) => {
          ev.stopPropagation();
          const id = ev.currentTarget.dataset.id;
          const cb = planesContainer.querySelector(`input[value="${id}"]`);
          if (cb) { cb.checked = false; actualizarChipsDesdeCheckboxes(); }
        });

        // al clicar chip abrimos editor (small convenience)
        el.addEventListener('click', () => {
          planesEditor.style.display = 'block';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    }

    // toggle editor
    toggleEditorBtn.addEventListener('click', () => {
      planesEditor.style.display = planesEditor.style.display === 'none' ? 'block' : 'none';
    });

    // redirigir para crear nuevo plan
    window.irACrearPlan = function() {
      if (idEdicion) window.location.href = `ejercicios.html?paciente=${idEdicion}`;
      else window.location.href = `ejercicios.html?paciente=nuevo`;
    };

    // BUSCADOR (filtrado local simple)
    buscador.addEventListener('input', (e) => {
      const qTxt = e.target.value.trim().toLowerCase();
      Array.from(listaEl.children).forEach(card => {
        const text = card.innerText.toLowerCase();
        card.style.display = text.includes(qTxt) ? '' : 'none';
      });
    });

    // helper XSS
    function escapeHtml(text) {
      if (!text && text !== 0) return '';
      return String(text)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // mostrar placeholder inicial
    noPacientesEl.style.display = 'block';
  </script>
</body>
</html>